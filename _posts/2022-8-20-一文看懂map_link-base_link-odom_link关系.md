---
layout: post
title: 一文看懂map、odom、base_link、laser之间的tf关系
subtitle: ROS系统下几个坐标系详解
author: 永清
categories: ROS
banner:
  image: /assets/images/banners/1.jpg
  opacity: 0.618
  background: "#000"
  height: "100vh"
  min_height: "38vh"
  heading_style: "font-size: 4.25em; font-weight: bold; text-decoration: underline"
  subheading_style: "color: gold"
tags: ROS robot
sidebar: []
---

> 这三者之间的关系到底是怎样的？尤其是map坐标系到odom坐标系之间的变换，到底是有什么意义呢？我当时被这个问题也是困扰了很久。现在经过实践终于有机会记录一下拙见，如有错误，还请指正！
这张经典的图大家都见过吧，已经不知道被偷了多少遍了🤣浅浅的手画了几张图，来说明一下几者的关系。
![经典图片](/assets/images/1/1.png)

首先说一下这三个坐标系分别是什么，再来解释变换关系。

+ map_frame
顾名思义，指地图坐标系。也就是你开map_server让他去发布的那个地图。 在map.yaml可以指定map坐标系的原点。 map坐标系是固定的，永恒不变的，相当于数轴。一般来说，定位的需求就是要返回在map坐标系下的坐标。

+ 里程计是什么？
机器人通过读取轮子上每个电机的编码器数据，能够实时得知轮子当前的运动状态。由四个轮子的运动数据可以解算出当前的运动速度，由陀螺仪可以得知当前角度。那么你想，有了当前速度和角度，是不是能计算出，在dt时间内车子的位移？累积起来是不是就是开机之后的总位移？

注意，上面说的用imu算出的是位移。我们假设机器人每时每刻能够返回一个(x,y)，也是一直积分得到的数字。你想，你开机没有动机器人的时候，是不是(0,0)？如果理想情况下，xy方向各自移动1m后，里程计返回的是不是(1,1)？但是现实情况下，轮式里程计难免会有打滑的情况。如果误差在10%的话，他的里程计返回的是不是（0.9，0.9）？

然后这里就是重点！你的机器人是不是以为你在xy方向各自移动了0.9米？但是事实上，你如果令机器人沿xy方向回退0.9米，你会发现机器人**并没有回到原点**，对吧？但是这个时候**里程计已经清零了**，机器人**以为**已经回到了一开始出发的位置。但是其实并没有。所以，由此可以引入里程计坐标系。

+ odom_frame
以下是我个人理解的定义（为了方便理解，与实际定义略有偏差）：
机器人因为打滑，你按照里程计得到的数据往回走，即使把里程计清零，也并不能返回到原来的出发点。把里程计走到清零那个点称作目前里程计坐标系的原点。
![里程计坐标系的误差产生](/assets/images/1/2.jpg)

也就是说，里程计座标系其实是一直在变的，因为轮式里程计的误差是不可预知的、积累的。你即使让他把现在的里程计清零，他在返回的时候仍然会累积误差。

map->odom这么一个坐标系变换，或者说两个原点之间的向量，其本质其实是描述了你里程计的累积误差。你**里程计归零**了，但是你在地图上的坐标系**并不是原来启动的位置**，那么中间的差不就是你**里程计的累积误差**吗？这个累计误差在实际工程中是由amcl节点计算并发布，不需要你去计算。

+ base_link
就是机器人坐标系，或者叫车体坐标系。把车体抽象为一个质点，这个质点所在的位置就是机器人坐标系的原点。在rviz里面可以调出来看到。说白了其实就是你机器人现在所在的位置。

+ odom->base_link
思考一下，这么一个坐标系变换描述的是什么呢？首先你要明确，这个是谁发布的？

答：是你的里程计发布的。他描述的就是：在你的机器人里程计看来，从原点走了多远？

需要注意的就是，他是机器人通过里程计得到的数据，是有误差的。这个误差也就是由map->odom描述。

+ laser_link
无论你的机器人是人形机器人还是方形机器人，你的激光雷达总不可能正好装在机器人抽象成的质点中心上吧？一般来说都装在前面或者是开阔的位置。那么他是不是和你机器人的实际中心有一个差别？base_link->laser_link描述的就是因为机器安装所导致的两者不重合的位移向量。一般都是机械建模软件里就可以得到。如果你精度要求不高的话，也可以用尺子去量。


总结一下：
![总结图](/assets/images/1/3.jpg)

说了这么多，那机器人究竟是怎么获知自己在地图坐标系下的位置呢？很简单，map->odom由amcl计算并发布，而你又发布了odom->base_link，一个函数不就算出了map到base_link了吗？

从思想的角度来说，其实就是你里程计有一个累积误差，而map->odom这个误差啊，由amcl计算出来，然后在你实际算TF变换的时候，把你里程计的累计误差给抵消掉。

为了方便理解，上面的语言都不是很精确，我本人也很讨厌那种根本叫人看不懂的文章，当时走了很多弯路，浪费了很多时间（甚至间接的导致我挂了几门课哈哈）

鄙人没有系统学过这些东西，都是大二做比赛的时候实际理解的，才疏学浅，妄言拙见，恳请大佬留言指正！看懂的话麻烦点一个免费的赞！